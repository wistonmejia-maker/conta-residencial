generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Unit {
  id                 String               @id @default(uuid())
  name               String
  taxId              String               @map("tax_id")
  email              String?
  observations       String?
  logoUrl            String?              @map("logo_url")
  bankAccountInfo    String?              @map("bank_account_info")
  propertyType       String?              @default("RESIDENTIAL") @map("property_type")
  totalTowers        Int?                 @map("total_towers")
  totalUnits         Int?                 @map("total_units")
  defaultPaymentType String               @default("INTERNAL") @map("default_payment_type")
  consecutiveSeed    Int                  @default(1) @map("consecutive_seed")
  address            String?
  createdAt          DateTime             @default(now()) @map("created_at")
  accountantId       String?              @map("accountant_id")
  adminId            String?              @map("admin_id")
  fiscalRevisorId    String?              @map("fiscal_revisor_id")
  gmailScanStartDate DateTime?            @map("gmail_scan_start_date")
  gmailProcessedLabel String?              @default("Procesado") @map("gmail_processed_label")
  gmailLabelingEnabled Boolean              @default(true) @map("gmail_labeling_enabled")
  gmailScanDaysBack    Int?                 @default(7) @map("gmail_scan_days_back")
  gmailAutoScanEnabled Boolean              @default(false) @map("gmail_auto_scan_enabled")
  gmailLastAutoScan    DateTime?            @map("gmail_last_auto_scan")
  organization_id    String?
  auditLogs          AuditLog[]
  bankMovements      BankMovement[]
  invoices           Invoice[]
  reports            MonthlyReport[]
  payments           Payment[]
  providerConfigs    ProviderUnitConfig[]
  accountant         Provider?            @relation("UnitAccountant", fields: [accountantId], references: [id])
  admin              Provider?            @relation("UnitAdmin", fields: [adminId], references: [id])
  fiscalRevisor      Provider?            @relation("UnitFiscalRevisor", fields: [fiscalRevisorId], references: [id])
  organization       Organization?        @relation(fields: [organization_id], references: [id])
  userUnitAccess     UserUnitAccess[]
  gmailToken         GmailToken?
  budgets            Budget[]
  aiFeedback         AIFeedback[]
  aiCustomPrompt     String?              @map("ai_custom_prompt")

  @@map("units")
}

model Budget {
  id        String   @id @default(uuid())
  unitId    String   @map("unit_id")
  year      Int
  month     Int
  category  String
  amount    Decimal  @db.Decimal(12, 2)
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")
  unit      Unit     @relation(fields: [unitId], references: [id])

  @@unique([unitId, year, month, category])
  @@map("budgets")
}

model GmailToken {
  id           String   @id @default(uuid())
  unitId       String   @unique @map("unit_id")
  unit         Unit     @relation(fields: [unitId], references: [id])
  email        String   @unique
  accessToken  String   @map("access_token")
  refreshToken String   @map("refresh_token")
  expiresAt    BigInt   @map("expires_at")
  createdAt    DateTime @default(now()) @map("created_at")
  updatedAt    DateTime @updatedAt @map("updated_at")

  @@map("gmail_tokens")
}

model Provider {
  id                    String               @id @default(uuid())
  name                  String
  taxType               String               @map("tax_type")
  nit                   String               @unique
  dv                    String
  email                 String?
  phone                 String?
  address               String?
  city                  String?
  bankAccount           String?              @map("bank_account")
  bankName              String?              @map("bank_name")
  accountType           String?              @map("account_type")
  defaultRetefuentePerc Decimal              @default(0) @map("default_retefuente_perc") @db.Decimal(5, 2)
  defaultReteicaPerc    Decimal              @default(0) @map("default_reteica_perc") @db.Decimal(5, 4)
  isRecurring           Boolean              @default(false) @map("is_recurring")
  recurringCategory     String?              @map("recurring_category")
  category              String?
  status                String               @default("ACTIVE")
  createdAt             DateTime             @default(now()) @map("created_at")
  updatedAt             DateTime             @updatedAt @map("updated_at")
  invoices              Invoice[]
  documents             ProviderDocument[]
  unitConfigs           ProviderUnitConfig[]
  unitsAsAccountant     Unit[]               @relation("UnitAccountant")
  unitsAsAdmin          Unit[]               @relation("UnitAdmin")
  unitsAsFiscalRevisor  Unit[]               @relation("UnitFiscalRevisor")

  @@map("providers")
}

model ProviderDocument {
  id         String    @id @default(uuid())
  providerId String    @map("provider_id")
  type       String
  fileName   String    @map("file_name")
  fileUrl    String    @map("file_url")
  fileSize   Int?      @map("file_size")
  expiresAt  DateTime? @map("expires_at")
  isExpired  Boolean   @default(false) @map("is_expired")
  uploadedAt DateTime  @default(now()) @map("uploaded_at")
  notes      String?
  provider   Provider  @relation(fields: [providerId], references: [id], onDelete: Cascade)

  @@map("provider_documents")
}

model ProviderUnitConfig {
  id          String   @id @default(uuid())
  providerId  String   @map("provider_id")
  unitId      String   @map("unit_id")
  isRecurring Boolean  @default(false) @map("is_recurring")
  category    String?
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")
  provider    Provider @relation(fields: [providerId], references: [id], onDelete: Cascade)
  unit        Unit     @relation(fields: [unitId], references: [id], onDelete: Cascade)

  @@unique([providerId, unitId])
  @@map("provider_unit_configs")
}

model Invoice {
  id               String           @id @default(uuid())
  unitId           String           @map("unit_id")
  providerId       String           @map("provider_id")
  invoiceNumber    String           @map("invoice_number")
  isAutogenerated  Boolean          @default(false) @map("is_autogenerated")
  invoiceDate      DateTime         @map("invoice_date")
  dueDate          DateTime?        @map("due_date")
  fileUrl          String?          @map("file_url")
  subtotal         Decimal          @db.Decimal(12, 2)
  taxIva           Decimal          @default(0) @map("tax_iva") @db.Decimal(12, 2)
  retefuenteAmount Decimal          @default(0) @map("retefuente_amount") @db.Decimal(12, 2)
  reteicaAmount    Decimal          @default(0) @map("reteica_amount") @db.Decimal(12, 2)
  totalAmount      Decimal          @map("total_amount") @db.Decimal(12, 2)
  description      String?
  pdfUrl           String?          @map("pdf_url")
  status           String           @default("PENDING")
  monthlyReportId  String?          @map("monthly_report_id")
  createdAt        DateTime         @default(now()) @map("created_at")
  source           String           @default("MANUAL")
  emailSubject     String?          @map("email_subject")
  emailSender      String?          @map("email_sender")
  emailDate        DateTime?        @map("email_date")
  report           MonthlyReport?   @relation(fields: [monthlyReportId], references: [id])
  provider         Provider         @relation(fields: [providerId], references: [id])
  unit             Unit             @relation(fields: [unitId], references: [id])
  paymentItems     PaymentInvoice[]
  aiFeedback       AIFeedback[]

  @@unique([providerId, invoiceNumber], name: "unique_provider_invoice")
  @@map("invoices")
}

model Payment {
  id                String           @id @default(uuid())
  unitId            String           @map("unit_id")
  consecutiveNumber Int?             @map("consecutive_number")
  manualConsecutive String?          @map("manual_consecutive")
  paymentDate       DateTime         @map("payment_date")
  sourceType        String           @map("source_type")
  amountPaid        Decimal          @map("amount_paid") @db.Decimal(12, 2)
  retefuenteApplied Decimal          @default(0) @map("retefuente_applied") @db.Decimal(12, 2)
  reteicaApplied    Decimal          @default(0) @map("reteica_applied") @db.Decimal(12, 2)
  netValue          Decimal          @map("net_value") @db.Decimal(12, 2)
  bankPaymentMethod String?          @map("bank_payment_method")
  transactionRef    String?          @map("transaction_ref")
  supportFileUrl    String?          @map("support_file_url")
  pilaFileUrl       String?          @map("pila_file_url")
  status            String           @default("DRAFT")
  hasAuditIssue     Boolean          @default(false) @map("has_audit_issue")
  hasPendingInvoice Boolean          @default(false) @map("has_pending_invoice")
  monthlyReportId   String?          @map("monthly_report_id")
  createdAt         DateTime         @default(now()) @map("created_at")
  source            String           @default("MANUAL")
  emailSubject      String?          @map("email_subject")
  emailSender       String?          @map("email_sender")
  emailDate         DateTime?        @map("email_date")
  conciliation      Conciliation?
  invoiceItems      PaymentInvoice[]
  aiFeedback        AIFeedback[]
  report            MonthlyReport?   @relation(fields: [monthlyReportId], references: [id])
  unit              Unit             @relation(fields: [unitId], references: [id])

  @@map("payments")
}

model PaymentInvoice {
  id            String  @id @default(uuid())
  paymentId     String  @map("payment_id")
  invoiceId     String  @map("invoice_id")
  amountApplied Decimal @map("amount_applied") @db.Decimal(12, 2)
  invoice       Invoice @relation(fields: [invoiceId], references: [id])
  payment       Payment @relation(fields: [paymentId], references: [id])

  @@map("payment_invoices")
}

model BankMovement {
  id              String        @id @default(uuid())
  unitId          String        @map("unit_id")
  transactionDate DateTime      @map("transaction_date")
  description     String?
  amount          Decimal       @db.Decimal(12, 2)
  referenceCode   String?       @map("reference_code")
  isConciliated   Boolean       @default(false) @map("is_conciliated")
  rawData         Json?         @map("raw_data")
  createdAt       DateTime      @default(now()) @map("created_at")
  unit            Unit          @relation(fields: [unitId], references: [id])
  conciliation    Conciliation?

  @@map("bank_movements")
}

model Conciliation {
  id             String       @id @default(uuid())
  paymentId      String       @unique @map("payment_id")
  bankMovementId String       @unique @map("bank_movement_id")
  conciliatedAt  DateTime     @default(now()) @map("conciliated_at")
  notes          String?
  bankMovement   BankMovement @relation(fields: [bankMovementId], references: [id])
  payment        Payment      @relation(fields: [paymentId], references: [id])

  @@map("conciliations")
}

model MonthlyReport {
  id          String    @id @default(uuid())
  unitId      String    @map("unit_id")
  month       String
  year        String
  status      String    @default("SENT")
  pdfUrl      String?   @map("pdf_url")
  createdAt   DateTime  @default(now()) @map("created_at")
  createdById String?   @map("created_by_id")
  invoices    Invoice[]
  unit        Unit      @relation(fields: [unitId], references: [id])
  payments    Payment[]

  @@map("monthly_reports")
}

model AuditLog {
  id          String   @id @default(uuid())
  unitId      String   @map("unit_id")
  entityType  String   @map("entity_type")
  entityId    String   @map("entity_id")
  issueType   String   @map("issue_type")
  description String
  resolved    Boolean  @default(false)
  createdAt   DateTime @default(now()) @map("created_at")
  unit        Unit     @relation(fields: [unitId], references: [id])

  @@map("audit_logs")
}

model Organization {
  id         String   @id
  name       String
  nit        String   @unique
  email      String
  phone      String?
  plan       String   @default("FREE")
  maxUnits   Int      @default(1)
  created_at DateTime @default(now())
  units      Unit[]
  users      User[]

  @@map("organizations")
}

model UserUnitAccess {
  id         String   @id
  user_id    String
  unit_id    String
  role       UnitRole @default(VIEWER)
  created_at DateTime @default(now())
  unit       Unit     @relation(fields: [unit_id], references: [id], onDelete: Cascade)
  user       User     @relation(fields: [user_id], references: [id], onDelete: Cascade)

  @@unique([user_id, unit_id])
  @@map("user_unit_access")
}

model User {
  id              String           @id
  email           String           @unique
  firebase_uid    String?          @unique
  first_name      String?
  last_name       String?
  phone           String?
  avatar_url      String?
  role            GlobalRole       @default(USER)
  organization_id String
  is_active       Boolean          @default(true)
  last_login_at   DateTime?
  created_at      DateTime         @default(now())
  userUnitAccess  UserUnitAccess[]
  organization    Organization     @relation(fields: [organization_id], references: [id])

  @@map("users")
}

enum GlobalRole {
  SUPER_ADMIN
  USER
}

enum UnitRole {
  OWNER
  ADMIN
  ACCOUNTANT
  FISCAL_REVISOR
  AUXILIARY
  VIEWER
}

model ScanningJob {
  id             String    @id @default(uuid())
  unitId         String    @map("unit_id")
  status         String    @default("PENDING") // PENDING, PROCESSING, COMPLETED, FAILED
  progress       Int       @default(0)
  totalItems     Int       @default(0)
  processedCount Int       @default(0)
  results        Json? // Array of results { status, file, type, id }
  error          String?
  createdAt      DateTime  @default(now()) @map("created_at")
  updatedAt      DateTime  @updatedAt @map("updated_at")
  completedAt    DateTime? @map("completed_at")

  @@map("scanning_jobs")
}

model AIFeedback {
  id            String    @id @default(uuid())
  unitId        String    @map("unit_id")
  documentType  String    @map("document_type") // INVOICE, PAYMENT
  invoiceId     String?   @map("invoice_id")
  paymentId     String?   @map("payment_id")
  comment       String
  suggestedRule String?   @map("suggested_rule")
  status        String    @default("PENDING") // PENDING, APPLIED, RESOLVED
  createdAt     DateTime  @default(now()) @map("created_at")
  resolvedAt    DateTime? @map("resolved_at")

  unit    Unit     @relation(fields: [unitId], references: [id])
  invoice Invoice? @relation(fields: [invoiceId], references: [id])
  payment Payment? @relation(fields: [paymentId], references: [id])

  @@map("ai_feedback")
}
